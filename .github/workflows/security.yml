# ============================================
# Galeria - Security CI/CD Pipeline
# ============================================
# Automated security scanning for pull requests and pushes

name: Security Scan

on:
  push:
    branches: [main, develop, staging]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # DEPENDENCY VULNERABILITY SCAN (SNYK)
  # ============================================
  snyk:
    name: Snyk Dependency Scan
    runs-on: ubuntu-latest
    # Skip on forks unless triggered manually
    if: github.event != 'schedule' || github.repository == github.event.repository.owner.name

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for better results

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Snyk test
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_SEVERITY_THRESHOLD: high
        with:
          args: --severity-threshold=high

      - name: Upload Snyk results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk.sarif

  # ============================================
  # STATIC CODE ANALYSIS (SEMGREP)
  # ============================================
  semgrep:
    name: Semgrep SAST Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: .semgrep.yaml
          # Only report new issues on PRs
          publishSarif: ${{ github.event_name == 'pull_request' }}
          # Don't fail on findings in PRs (just report them)
          continueOnError: ${{ github.event_name == 'pull_request' }}

      - name: Upload Semgrep results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif

  # ============================================
  # NPM AUDIT
  # ============================================
  npm-audit:
    name: npm audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --production

      - name: Check for high/critical vulnerabilities
        run: |
          AUDIT_RESULT=$(npm audit --production --json)
          echo "$AUDIT_RESULT"

          # Parse for high/critical vulnerabilities
          if echo "$AUDIT_RESULT" | grep -q '"vulnerabilities":\s*{\s*"high":\s*[1-9]'; then
            echo "âŒ High severity vulnerabilities found!"
            exit 1
          fi

          if echo "$AUDIT_RESULT" | grep -q '"vulnerabilities":\s*{\s*"critical":\s*[1-9]'; then
            echo "âŒ Critical severity vulnerabilities found!"
            exit 1
          fi

          echo "âœ… No high or critical vulnerabilities found"

  # ============================================
  # SECRETS SCANNING (GITLEAKS)
  # ============================================
  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: Gitleaks secret scanning
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml

  # ============================================
  # CODE SECURITY CHECK (ESLint)
  # ============================================
  security-lint:
    name: Security Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint with security rules
        run: npm run lint

  # ============================================
  # DEPENDABOT UPDATES (AUTOMATED)
  # ============================================
  dependabot-notify:
    name: Dependabot Notification
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.actor == 'dependabot[bot]'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Snyk test on Dependabot PR
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium

      - name: Comment PR with results
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const snykResult = `${{ steps.snyk.outputs.result }}`;

            if (snykResult.includes('Vulnerabilities found')) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.name,
                body: `## ðŸ”’ Security Scan Results\n\n${snykResult}\n\nâš ï¸ Please review the vulnerabilities before merging.`
              });
            } else {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.name,
                body: `## âœ… Security Scan Results\n\nNo vulnerabilities found! This PR is safe to merge.`
              });
            }

  # ============================================
  # SECURITY SUMMARY
  # ============================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [snyk, semgrep, npm-audit, secrets-scan, security-lint]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Snyk | ${{ needs.snyk.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Semgrep | ${{ needs.semgrep.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| npm audit | ${{ needs.npm-audit.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secrets scan | ${{ needs.secrets-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security lint | ${{ needs.security-lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [[ "${{ needs.snyk.result }}" == "success" &&
                "${{ needs.semgrep.result }}" == "success" &&
                "${{ needs.npm-audit.result }}" == "success" ]]; then
            echo "### âœ… All security checks passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The codebase is secure and ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Security issues detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed checks above before merging." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
